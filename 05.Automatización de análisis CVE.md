# Automatización de análisis CVE's <!-- omit in toc -->

# 1. Crear cuenta
> [Sonar](https://www.sonarsource.com/products/sonarcloud)

> [Lenguajes](https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/languages/overview/)

# 2. Nueva organización
- Importar de Github

# 3. Nuevo Proyecto
- rest-api
- Previous Version
- Create Project

# 4. Explorar
## 4.1. Main branch
- Summary
- Issues
- Security Hotspots
- Code
## 4.2. Pull Requests

# 5. Agregar el archivo sonarTest.js a /src
## 5.1. Sincronizar los cambios con GitHub
# 6. Revisar Issues
# 7. Integrar Sonar con Actions
## 7.1. Crear un secret en Github con el valor:
- Administration - Analysis Method - Github actions
```
SONAR_TOKEN: xxxxxxxx
```

## 7.2. Integrar el workflow: deploy.yaml
> [Sonar Cloud](https://github.com/marketplace/actions/sonarcloud-scan)


- Agregar la variable SONAR_TOKEN
- Agregar la variable GITHUB_TOKEN


# 8. Sincronizar con Github y validar el workflow
- Corregir errores de pruebas unitarias si es necesario.
- Corregir errores del flujo de Sonar (Information - About this project)
  - SONAR_ORGANIZATION
  - SONAR_PROJECT_KEY
	- ERROR: You are running CI analysis while Automatic Analysis is enabled. Please consider disabling one or the other.
  	- Administration - Analysis Method: Auto Analysis deshabilitado.

# 9. Capturar Estado
Ejemplo:
curl -s -u $SONAR_TOKEN: https://sonarcloud.io/api/qualitygates/project_status\?projectKey=$SONAR_PROJECT_KEY


```yaml
      - name: Get SonarCloud status
        run: |
         echo "SONAR_STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN}}: https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ secrets.SONAR_PROJECT_KEY }} | jq -r '.projectStatus.status')" >> $GITHUB_ENV
```

## 9.1. Leer el estado
```yaml
      - name: Sonar Status
        run: echo ${{ env.SONAR_STATUS }}

      - name: Check Status
        if: ${{ env.SONAR_STATUS == 'ERROR' }}
        run: exit 1
```
Resultado:
```
ERROR
```

# 10. Reparar errores
- src/sonarTest.js
- Cambiar "var" por "const"
- Eliminar "unusedVar"
- En getuserName(), cambiar la variable "name"
- Publicar
- Validar resultados en Sonar Cloud
- Eliminar el resto de erorres hasta lograr pasar el test

# 11. Pregunta, el orden del flujo es el correcto?

# Snyk
> [info](https://nodejs.org/en/docs/guides/security)

> [snyk best](https://snyk.io/learn/nodejs-security-best-practice/#best)

> [docker](https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/)
