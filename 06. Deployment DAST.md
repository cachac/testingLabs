# 06. Deployment DAST <!-- omit in toc -->

# 1. Introducci칩n al escenario
La aplicaci칩n tiene una vulnerabilidad de tipo XSS (CROSS SITE SCRIPTING)

```js
router.get('/search', (req, res) => {
  const query = req.query.q;

  // Vulnerable rendering
  res.send(`<h1>Search Results for: ${query}</h1>`);
});
```

## 1.1. Probar el api en browser
```
http://<PUBLIC_IP>:3000/search?q=123456789
```

## 1.2. Explotar la vulnerabilidad XSS
```
http://<PUBLIC_IP>:3000/search?q=<script>alert('XSS Exploited!')</script>
```

# 2. Agregar el action de CODEQL al workflow
.github/workflows/dast-test.yaml

> [CODEQL](https://github.com/github/codeql-action)

```yaml
name: deploy

on:
  push:
    branches: ["main"]

jobs:
  build:
    name: SAST Test

		runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v3
        name: Checkout code

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript'

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
```

# 3. Revisar los resultados del an치lisis
 GitHub - Security tab - Code scannig

# 4. Reparar la vulnerabilidad y validar el an치lisis
```js
res.send({ query: query });
```

# 5. Opcional. Agregar el action de ZAP al workflow
> [OWASP ZAP](https://github.com/marketplace/actions/zap-api-scan)

.github/workflows/zap-dast-test.yaml

```yaml
name: deploy

on:
  push:
    branches: ["main"]

env:
  REGISTRY: cachac
  IMAGE_NAME: rest_api

jobs:
  build:
    name: ZAP - DAST Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Checkout code

      - name: run api
        run: |
          npm install
          npm run dev&

      - name: ZAP Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'http://localhost:3000/search?q=123'
```

## 5.1. Hacer push a GitHub

> Hay un problema conocido a nivel de Github por la cantidad de request generados.




